{% extends "base.html" %}
{% block content %}
<section class="grid">
  <div class="card">
    <h2>Budgets</h2>

    {% for r in rows %}
      {% set s = r.sum %}
      {% set pct = 0 if s.effective<=0 else (s.pct if s.pct < 100 else 100) %}
      {% if s.pct < 80 %}
        {% set color = 'green' %}
      {% elif s.pct < 100 %}
        {% set color = 'yellow' %}
      {% else %}
        {% set color = 'red' %}
      {% endif %}
      <div class="budget" style="margin-bottom:12px;">
        <div class="row-head">
          <strong>{{ r.cat.name }}</strong>
          <span>${{ '%.2f'|format(s.spent) }} / ${{ '%.2f'|format(s.effective) }}</span>
        </div>
        <div class="muted small">
          Base ${{ '%.2f'|format(s.base) }} + Carry {{ '+' if s.carry_in>=0 else '' }}${{ '%.2f'|format(s.carry_in) }}
          = Effective ${{ '%.2f'|format(s.effective) }}
        </div>
        <div class="bar">
          <div class="bar-fill {{color}}" style="width: {{ '%.0f'|format(pct) }}%"></div>
          {% if s.over_by > 0 %}
            <div class="bar-over">+${{ '%.2f'|format(s.over_by) }}</div>
          {% endif %}
        </div>
      </div>
    {% endfor %}

    <!-- Month progress widget -->
    <div class="monthbox" style="margin-top:32px;">
      <div class="row-head">
        <strong>Month progress</strong>
        <span>{{ '%.0f'|format(mprog.pct) }}% · {{ mprog.days_left }} day{% if mprog.days_left != 1 %}s{% endif %} left</span>
      </div>
      <div class="bar">
        <div class="bar-fill accent" style="width: {{ '%.0f'|format(mprog.pct) }}%"></div>
      </div>
      <div class="muted small">{{ mprog.start_str }} → {{ mprog.end_str }}</div>
    </div>
  </div>

  <div class="card">
    <h2>Add Item</h2>
    <form class="stack" action="{{ url_for('add') }}" method="post">
      <select name="category_id" required>
        <option value="" disabled selected>Category</option>
        {% for r in rows %}
          <option value="{{ r.cat.id }}">{{ r.cat.name }}</option>
        {% endfor %}
      </select>
      <input type="text" name="name" placeholder="Name" required>
      <input class="num" type="number" step="0.01" name="amount" placeholder="Amount" required>
      <button type="submit">Save</button>
    </form>

    <h3 style="margin-top:1rem;">Recent</h3>
    <ul class="list">
      {% for p in recent %}
        <li>
          <div>
            <strong>{{ p.category.name }}</strong> — ${{ '%.2f'|format(p.amount) }}
            <small> · {{ p.ts.strftime('%Y-%m-%d') }} · {{ p.name }}</small>
          </div>
          <div>
            <a href="{{ url_for('edit', pid=p.id) }}">Edit</a>
            <form action="{{ url_for('delete', pid=p.id) }}" method="post" style="display:inline;">
              <button type="submit" class="ghost">Delete</button>
            </form>
          </div>
        </li>
      {% else %}
        <li class="muted">No items yet.</li>
      {% endfor %}
    </ul>
  </div>
</section>
{% endblock %}
